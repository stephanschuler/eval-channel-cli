#!/bin/zsh

local backChannelResourceDirectory=`realpath $0 | xargs dirname`
local mergeStdinAndStdoutIntoBackchannel="$backChannelResourceDirectory/mergeStdinAndStdoutIntoBackchannel.php"

alias _merge-stdin-and-stdout-into-backchannel=$mergeStdinAndStdoutIntoBackchannel

function _callWithBackChannel() {
  local backChannelMessage
  _merge-stdin-and-stdout-into-backchannel $@ | while IFS= read -r backChannelMessage; do
    backChannelMessage=$(echo $backChannelMessage | base64 -D)
    eval $backChannelMessage
  done
}

unset mergeStdinAndStdoutIntoBackchannel
unset backChannelResourceDirectory
